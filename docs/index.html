
<!DOCTYPE html>
<html>
<head>
    <title>Collegiate Survivability Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Custom styles -->
    <style>
        #map { height: 100vh; width: 100%; }
        .legend { background: white; padding: 10px; line-height: 1.5em; }
    </style>
</head>
<body>
    <select id="quantileFilter" onchange="updateMap()">
        <option value="all">Show All</option>
        <option value="0">Critical</option>
        <option value="1">At-Risk</option>
        <option value="2">Vulnerable</option>
        <option value="3">Watchlist</option>
        <option value="4">Stable</option>
        <option value="5">Healthy</option>
        <option value="6">Strong</option>
        <option value="7">Elite</option>
    </select>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- PapaParse to parse CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <script>
        let map = L.map('map').setView([39.5, -98.35], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const colorScale = [
            "#8b0000", "#e66101", "#fdb863", "#f7f7f7",
            "#c2e699", "#78c679", "#31a354", "#006837"
        ];

        let markers = [];

        function getQuantileGroup(csi) {
            return Math.floor(csi * 8); // 0 to 7
        }

        function updateMap() {
            const selected = document.getElementById("quantileFilter").value;
            markers.forEach(m => map.removeLayer(m));
            markers = [];

            Papa.parse("national_map_data.csv", {
                download: true,
                header: true,
                complete: function(results) {
                    results.data.forEach(row => {
                        const lat = parseFloat(row.Latitude);
                        const lon = parseFloat(row.Longitude);
                        const csi = parseFloat(row["Collegiate Survivability Index (CSI)"]);

                        if (isNaN(lat) || isNaN(lon) || isNaN(csi)) return;

                        const group = getQuantileGroup(csi);
                        if (selected !== "all" && group != selected) return;

                        const color = colorScale[group];
                        const marker = L.circleMarker([lat, lon], {
                            radius: 6,
                            fillColor: color,
                            color: "#000",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        const popup = `
                            <strong>${row.University}</strong><br/>
                            Rank: ${row.Rank}<br/>
                            CSI: ${(csi * 100).toFixed(1)}%<br/>
                            Market: ${(parseFloat(row["Market Saturation Percentile"]) * 100).toFixed(1)}%<br/>
                            Academic: ${(parseFloat(row["AE Percentile"]) * 100).toFixed(1)}%<br/>
                            aCFI: ${(parseFloat(row["aCFI Percentile"]) * 100).toFixed(1)}%<br/>
                            Endowment (2028): $${parseFloat(row.Endowment).toLocaleString()}<br/>
                            Liabilities (2028): $${parseFloat(row.Liabilities).toLocaleString()}
                        `;

                        marker.bindPopup(popup);
                        marker.addTo(map);
                        markers.push(marker);
                    });
                }
            });
        }

        updateMap();
    </script>
</body>
</html>
